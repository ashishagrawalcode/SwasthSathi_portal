{% extends "layout.html" %}
{% block title %}Lab Report Assessment{% endblock %}

{% block content %}
<style>
    .lab-report-container { max-width: 800px; margin: auto; }
    .upload-box {
        border: 2px dashed #0d6efd;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }
    .upload-box:hover { background-color: #e9ecef; }
    .upload-box i { font-size: 3rem; color: #0d6efd; }
    .upload-box p { margin-top: 1rem; font-size: 1.1rem; color: #6c757d; }
    #file-upload-input { display: none; }
    #image-preview-container {
        display: none;
        text-align: center;
        margin-top: 1.5rem;
    }
    #image-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .analysis-card {
        background-color: #fff;
        border-radius: 8px;
        padding: 2rem;
        margin-top: 2rem;
        border: 1px solid #e9ecef;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .analysis-card h5 { color: #0d6efd; }
    .analysis-card .rendered-content p, .analysis-card .rendered-content li {
        color: #495057;
        line-height: 1.6;
    }
    .disclaimer-box {
        background-color: #fff3cd;
        border-left: 5px solid #ffc107;
        padding: 1rem;
        margin-top: 2rem;
        border-radius: 5px;
    }
</style>

<div class="container page-container lab-report-container">
    <div class="section-header">
        <h2>AI-Assisted Lab Report Assessment</h2>
        <p>Upload an image of your lab report to get a simplified, AI-powered analysis.</p>
    </div>

    <!-- Main Content Box -->
    <div class="content-box">
        <div id="error-message" class="alert alert-danger" style="display: none;"></div>
        
        <!-- File Upload Area -->
        <div id="upload-container">
            <label for="file-upload-input" class="upload-box" id="upload-box">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click here to select an image of your lab report</p>
                <small class="text-muted">Supports JPG, PNG, WEBP formats</small>
            </label>
            <input type="file" id="file-upload-input" accept="image/jpeg, image/png, image/webp">
        </div>
        
        <!-- Image Preview and Analyze Button -->
        <div id="image-preview-container">
            <img id="image-preview" src="#" alt="Lab Report Preview">
            <button id="analyze-btn" class="btn btn-primary w-100 mt-3">Analyze Report with AI</button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
        <p class="mt-3">AI is analyzing your report. This may take a moment...</p>
    </div>

    <!-- AI Analysis Result -->
    <div id="analysis-result-container" class="analysis-card" style="display: none;">
        <h5><i class="fas fa-file-medical-alt"></i> Simplified AI Analysis</h5>
        <hr>
        <div id="analysis-content" class="rendered-content"></div>
        <div class="disclaimer-box mt-4">
            <p class="mb-0">
                <i class="fas fa-exclamation-triangle"></i> <strong>Disclaimer:</strong> This is an AI-generated summary and is NOT a medical diagnosis. Consult a qualified doctor to understand your health status.
            </p>
        </div>
        <button onclick="window.location.reload()" class="btn btn-secondary w-100 mt-4">Analyze Another Report</button>
    </div>
</div>

<!-- Marked.js library to render AI's markdown response -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const API_KEY = "AIzaSyCYcu-XR2BqAPN9zuF4EeyDLmt6WdvqJbk";
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`;

    const uploadBox = document.getElementById('upload-box');
    const fileInput = document.getElementById('file-upload-input');
    const previewContainer = document.getElementById('image-preview-container');
    const previewImg = document.getElementById('image-preview');
    const analyzeBtn = document.getElementById('analyze-btn');
    const loadingSpinner = document.getElementById('loading-spinner');
    const resultContainer = document.getElementById('analysis-result-container');
    const analysisContent = document.getElementById('analysis-content');
    const errorMessageDiv = document.getElementById('error-message');
    const uploadContainer = document.getElementById('upload-container');

    let fileAsBase64 = null;
    let fileMimeType = null;

    uploadBox.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        // Display image preview
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            uploadContainer.style.display = 'none';
            previewContainer.style.display = 'block';

            // Convert file to base64 for the API call
            fileAsBase64 = e.target.result.split(',')[1];
            fileMimeType = file.type;
        }
        reader.readAsDataURL(file);
    });

    analyzeBtn.addEventListener('click', async () => {
        if (!fileAsBase64 || !fileMimeType) {
            displayError("Please select a valid image file first.");
            return;
        }

        previewContainer.style.display = 'none';
        loadingSpinner.style.display = 'block';
        errorMessageDiv.style.display = 'none';

        try {
            const systemPrompt = "You are a helpful medical AI assistant. Your role is to analyze an image of a patient's lab report and provide a simplified explanation of the results. You must not provide a diagnosis or medical advice. Your task is to identify key metrics in the report, state their values, indicate if they are within standard normal ranges, and explain what each metric measures in simple, easy-to-understand language. Structure your response clearly using Markdown (headings, bold text, lists).";
            const userPrompt = "Please analyze the attached lab report image and provide a simplified summary of the findings.";

            const payload = {
                contents: [{
                    parts: [
                        { text: userPrompt },
                        { inline_data: { mime_type: fileMimeType, data: fileAsBase64 } }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error?.message || `API Error: ${response.statusText}`);
            }

            const analysisText = result.candidates[0].content.parts[0].text;
            displayAnalysis(analysisText);

        } catch (error) {
            console.error("Error analyzing report:", error);
            displayError(`An error occurred: ${error.message}. Please try again.`);
            uploadContainer.style.display = 'block'; // Show upload box again
        } finally {
            loadingSpinner.style.display = 'none';
        }
    });

    function displayAnalysis(markdownText) {
        // Use the Marked.js library to convert Markdown text to HTML
        analysisContent.innerHTML = marked.parse(markdownText);
        resultContainer.style.display = 'block';
    }

    function displayError(message) {
        errorMessageDiv.textContent = message;
        errorMessageDiv.style.display = 'block';
    }
});
</script>
{% endblock %}
